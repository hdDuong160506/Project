<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gợi ý sản phẩm theo vị trí</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      max-width: 900px;
      margin: 24px auto;
      padding: 0 16px
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px
    }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      cursor: pointer
    }

    .bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0
    }

    #status {
      white-space: pre-wrap;
      color: #555
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 12px
    }

    .card {
      border: 1px solid #eee;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
      background: #fff
    }

    .thumb {
      aspect-ratio: 16/10;
      object-fit: cover;
      width: 100%;
      background: #f6f6f6
    }

    .pad {
      padding: 12px
    }

    .name {
      font-weight: 600;
      margin: 0 0 6px
    }

    .muted {
      color: #666;
      font-size: 14px;
      margin: 4px 0
    }

    .price {
      font-weight: 700;
      margin: 6px 0
    }

    .tag {
      display: inline-block;
      background: #f2f2f2;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      margin-top: 6px
    }

    .empty {
      padding: 16px;
      border: 1px dashed #ccc;
      border-radius: 12px;
      text-align: center;
      color: #666
    }
  </style>
  <script>
    const API_BASE = 'http://127.0.0.1:5000';
  </script>
</head>

<body>
  <header>
    <h2>Gợi ý sản phẩm theo vị trí</h2>
  </header>

  <div class="bar">
    <button id="btn-gps">Lấy vị trí hiện tại</button>
  </div>

  <div class="bar">
    <input id="city" placeholder="Nhập vị trí của bạn (VD: Hà Nội, TPHCM): "
      style="flex:1;min-width:240px;padding:10px;border-radius:10px;border:1px solid #ddd" />
    <button id="btn-city">Tìm theo tỉnh/thành</button>
  </div>

  <div id="status"></div>
  <div id="results" class="grid"></div>

  <script>
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">\
      <rect width="100%" height="100%" fill="#f6f6f6"/>\
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,Segoe UI,Arial" font-size="20" fill="#999">No image</text>\
      </svg>'
    );

    function vnd(n) { return (n === null || n === undefined) ? "" : Number(n).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); }

    function render(items, hint = "") {
      resultsEl.innerHTML = ""; // Xóa nội dung cũ
      if (!items || items.length === 0) {
        resultsEl.innerHTML = `<div class="empty">Không có sản phẩm phù hợp${hint ? ` (${hint})` : ""}.</div>`;
        return;
      }
      for (const it of items) {
        const card = document.createElement('div');
        card.className = 'card';
        const img = document.createElement('img');
        img.className = 'thumb';
        img.loading = 'lazy'; // Tải ảnh khi cuộn đến
        img.src = it.image_url || PLACEHOLDER;
        img.alt = it.name || "image";
        img.onerror = () => { img.src = PLACEHOLDER; };
        card.appendChild(img);

        const box = document.createElement('div'); box.className = 'pad';
        const dist = (typeof it.distance_km === 'number') ? (it.distance_km.toFixed(2) + ' km') : '';
        box.innerHTML = `
          <div class="name">${it.name || ""}</div>
          <div class="price">${vnd(it.price)}</div>
          <div class="muted">${it.address || ""}</div>
          <div class="tag">${it.shop || "Cửa hàng"} · ${dist}</div>
        `;
        card.appendChild(box);
        resultsEl.appendChild(card);
      }
    }

    async function suggestProducts(lat, lon, limit = 20) {
      const res = await fetch(`${API_BASE}/api/suggest-products`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ latitude: lat, longitude: lon, limit })
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => res.statusText);
        throw new Error(`API error ${res.status}: ${txt}`);
      }
      return res.json();
    }

    async function suggestProductsByCity(city, limit = 50) {
      const res = await fetch(`${API_BASE}/api/suggest-products`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ city, limit })
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => res.statusText);
        throw new Error(`API error ${res.status}: ${txt}`);
      }
      return res.json();
    }

    async function resolveAndSearch(lat, lon) {
      try {
        const data = await suggestProducts(lat, lon);
        render(data.results, `gần vị trí của bạn`);
        statusEl.textContent = `Kết quả: ${data.count}`;
      } catch (e) {
        statusEl.textContent = `API lỗi: ${e.message}`;
      }
    }

    const GPS_OPTS = { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 };

    async function handleGPS() {
      if (!navigator.geolocation) {
        statusEl.textContent = 'Trình duyệt không hỗ trợ Geolocation';
        return;
      }
      statusEl.textContent = 'Đang lấy vị trí của bạn...';
      let done = false;
      const timer = setTimeout(() => {
        if (!done) statusEl.textContent = 'Không thể lấy vị trí GPS';
      }, 30000);

      // Lấy GPS 
      navigator.geolocation.getCurrentPosition(async (pos) => {
        if (done) return;
        done = true;
        clearTimeout(timer); // Hủy bộ đếm để tránh in ra
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        await resolveAndSearch(lat, lon);
      }, (err) => {
        // Không đổi trạng thái ngay; để báo lỗi sau 30s nếu chưa lấy được
        console.warn('Geolocation error:', err);
      }, GPS_OPTS);
    }


    document.getElementById('btn-gps').addEventListener('click', handleGPS);
    document.getElementById('btn-city').addEventListener('click', async () => {
      const cityInput = document.getElementById('city').value.trim();
      if (!cityInput) { statusEl.textContent = 'Vui lòng nhập tỉnh/thành'; return; }
      try {
        statusEl.textContent = `Đang tìm sản phẩm tại ${cityInput}...`;
        const data = await suggestProductsByCity(cityInput);
        render(data.results, `tại ${data.city || cityInput}`);
        statusEl.textContent = `Tỉnh/Thành: ${data.city || cityInput}\nKết quả: ${data.count}`;
      } catch (e) {
        statusEl.textContent = `API lỗi: ${e.message}`;
      }
    });
  </script>
</body>

</html>
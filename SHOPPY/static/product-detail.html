<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi ti·∫øt s·∫£n ph·∫©m - SHOPPY</title>
    <link rel="stylesheet" href="style2.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Inter, system-ui, "Segoe UI", Roboto, Arial;
            line-height: 1.4;
            color: #333;
            background: #f0f2f5;
            animation: pageFadeIn 0.5s ease-in-out;
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.page-fade-out {
            animation: pageFadeOut 0.5s ease-in-out forwards;
        }

        @keyframes pageFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .breadcrumb {
            padding: 15px 60px;
            font-size: 14px;
            background: #e9ecef;
            margin-top: 130px;
        }

        .breadcrumb a {
            color: #00aaff;
            text-decoration: none;
        }

        main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        #cart-popup {
            display: none;
            position: fixed;
            top: 100px;
            right: 60px;
            width: 320px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 12px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.2);
            padding: 16px;
            z-index: 2100;
        }

        .cart-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px dotted #eee;
            padding-bottom: 5px;
        }

        .cart-item img {
            width: 54px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }

        .qty {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .small-btn {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }

        .cart-btn {
            background: #00a2ff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .cart-btn:hover {
            background: #1130b9;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.2;
            }
        }

        #voice_popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .voice-popup-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .listening-dot {
            font-size: 40px;
            color: #ff4444;
            animation: blink 1s infinite;
            margin: 10px 0;
            height: 40px;
            line-height: 40px;
        }

        .product-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .product-image {
            flex: 1;
            min-width: 300px;
        }

        .product-image img {
            max-width: 80%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #eee;
            margin: 0 auto;
            display: block;
        }

        .product-info {
            flex: 1.5;
            min-width: 400px;
        }

        .product-info h2 {
            font-size: 28px;
            font-weight: 600;
        }

        .product-info .price {
            font-size: 26px;
            font-weight: 700;
            color: #00aaff;
            background: #f0f8ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .product-description {
            font-size: 15px;
            color: #555;
            line-height: 1.6;
        }

        .actions-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quantity-selector span {
            font-size: 16px;
            font-weight: 500;
        }

        .qty-btn,
        .qty-input {
            width: 40px;
            height: 40px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .qty-btn {
            cursor: pointer;
            background: #fff;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        .btn-add-cart,
        .btn-buy-now {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-add-cart {
            background: #eef3ff;
            color: #00aaff;
            border: 1px solid #00aaff;
        }

        .btn-buy-now {
            background: #00aaff;
            color: white;
        }

        .reviews-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .reviews-header {
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .reviews-header h3 {
            font-size: 24px;
            color: #333;
            margin: 0;
        }

        .review-stats {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .big-star {
            color: #facc15;
            font-size: 2rem;
            font-weight: bold;
        }

        .total-count {
            color: #666;
            font-size: 0.9rem;
        }

        .review-form-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #eee;
        }

        .star-rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star-rating-input input {
            display: none;
        }

        .star-rating-input label {
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating-input input:checked~label,
        .star-rating-input label:hover,
        .star-rating-input label:hover~label {
            color: #facc15;
        }

        .review-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 80px;
            margin-bottom: 10px;
            font-family: inherit;
            resize: vertical;
        }

        .btn-submit-review {
            background: #1867f8;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-submit-review:hover {
            background: #1557d1;
        }

        .review-item {
            border-bottom: 1px solid #eee;
            padding: 20px 0;
            display: flex;
            gap: 15px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            background: #e4e6eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }

        .review-content {
            flex: 1;
        }

        .review-author {
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }

        .review-stars-static {
            color: #facc15;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .review-text {
            color: #444;
            line-height: 1.5;
        }

        .review-time {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            #cart-popup {
                top: 185px;
                right: 15px;
                width: calc(100% - 30px);
            }
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="navbar-top">
            <div class="nav-links-left">
                <a href="#">K√™nh Ng∆∞·ªùi B√°n</a><span>|</span><a href="#">Tr·ªü th√†nh Ng∆∞·ªùi b√°n Shoppy</a><span>|</span><a
                    href="#">K·∫øt n·ªëi</a>
            </div>
            <div class="nav-links-right" style="display: flex; align-items: center; gap: 12px;">
                <a href="#">üîî Th√¥ng b√°o</a><a href="#">‚ùì H·ªó Tr·ª£</a>
                <a href="#" class="auth-link" id="account-link" onclick="window.location.href='account.html'">T√†i
                    Kho·∫£n</a>
                <div id="logout-link" title="ƒêƒÉng Xu·∫•t" style="margin-left: 8px; cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"
                        fill="#FFFFFF">
                        <path
                            d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-240-56-56 94-94H440v-80h238l-94-94 56-56 200 200-200 200Z" />
                    </svg>
                </div>
            </div>
        </div>
        <div class="navbar-main">
            <div class="nav-left">
                <a href="index.html" class="brand-link">
                    <img src="images/logo/logo1.png" alt="Logo" class="brand-logo">
                    <div class="brand">SHOPPY</div>
                </a>
            </div>
            <div class="nav-center-search">
                <form id="search_form" onsubmit="event.preventDefault();">
                    <div class="search-icon-left" title="B·ªô l·ªçc t√¨m ki·∫øm" onclick="toggleFilterMenu()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="#5f6368">
                            <path
                                d="M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Zm40-308 198-252H282l198 252Zm0 0Z" />
                        </svg>
                    </div>
                    <input type="text" name="search" id="search_input" placeholder="T√¨m ki·∫øm tr√™n Shoppy..."
                        autocomplete="off" />
                    <div class="search-actions-right">
                        <button type="button" onclick="startVoiceSearch()" class="icon-btn" title="T√¨m b·∫±ng gi·ªçng n√≥i">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#5f6368">
                                <path
                                    d="M480-400q-50 0-85-35t-35-85v-240q0-50 35-85t85-35q50 0 85 35t35 85v240q0 50-35 85t-85 35Zm0-240Zm-40 520v-123q-104-14-172-93t-68-184h80q0 83 58.5 141.5T480-320q83 0 141.5-58.5T680-520h80q0 105-68 184t-172 93v123h-80Zm40-360q17 0 28.5-11.5T520-520v-240q0-17-11.5-28.5T480-800q-17 0-28.5 11.5T440-760v240q0 17 11.5 28.5T480-480Z" />
                            </svg>
                        </button>
                        <button type="submit" class="icon-btn search-submit" title="T√¨m ki·∫øm">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#1867f8">
                                <path
                                    d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z" />
                            </svg>
                        </button>
                    </div>
                    <div id="filter-dropdown" class="filter-dropdown-menu">
                        <div class="filter-group">
                            <label>Kho·∫£ng c√°ch:</label>
                            <select name="distance_filter" id="distance_filter" class="custom-select">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">D∆∞·ªõi 1 km</option>
                                <option value="3">D∆∞·ªõi 3 km</option>
                                <option value="5">D∆∞·ªõi 5 km</option>
                                <option value="10">D∆∞·ªõi 10 km</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>M·ª©c gi√°:</label>
                            <select name="price_filter" id="price_filter" class="custom-select">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">D∆∞·ªõi 50k</option>
                                <option value="2">50k - 100k</option>
                                <option value="3">100k - 200k</option>
                                <option value="4">200k - 500k</option>
                                <option value="5">500k - 1tr</option>
                                <option value="6">Tr√™n 1tr</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="nav-right">
                <button class="cart-btn-icon" id="open-cart">
                    <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"
                        fill="white">
                        <path
                            d="M280-80q-33 0-56.5-23.5T200-160q0-33 23.5-56.5T280-240q33 0 56.5 23.5T360-160q0 33-23.5 56.5T280-80Zm400 0q-33 0-56.5-23.5T600-160q0-33 23.5-56.5T680-240q33 0 56.5 23.5T760-160q0 33-23.5 56.5T680-80ZM246-720l96 200h280l110-200H246Zm-38-80h590q23 0 35 20.5t1 41.5L692-482q-11 20-29.5 31T622-440H324l-44 80h480v80H280q-45 0-68-39.5t-2-78.5l54-98-144-304H40v-80h130l38 80Zm134 280h280-280Z" />
                    </svg>
                    <span class="cart-count-bubble" id="cart-count" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </header>
    <nav class="breadcrumb"><a href="index.html">Trang ch·ªß</a> / <span>Chi ti·∫øt s·∫£n ph·∫©m</span></nav>
    <main>
        <div class="product-container">
            <div class="product-image"><img id="product-image-main" src="" alt="·∫¢nh s·∫£n ph·∫©m"></div>
            <div class="product-info">
                <h2 id="product-name">ƒêang t·∫£i...</h2>
                <div id="product-subtitle" style="margin-bottom: 15px; color: #555;"></div>
                <div class="price" id="product-price">0</div>
                <h3 class="section-title">M√¥ t·∫£ s·∫£n ph·∫©m</h3>
                <p class="product-description" id="product-description">ƒêang t·∫£i m√¥ t·∫£...</p>
                <h3 class="section-title">C·ª≠a h√†ng cung c·∫•p:</h3>
                <div class="store-list" id="selected-store-detail"></div>
                <div class="actions-container">
                    <div class="quantity-selector">
                        <span>S·ªë L∆∞·ª£ng</span>
                        <button class="qty-btn" id="qty-minus">-</button>
                        <input type="text" class="qty-input" id="qty-input" value="1" readonly>
                        <button class="qty-btn" id="qty-plus">+</button>
                    </div>
                    <div class="buttons">
                        <button class="btn-add-cart" id="add-to-cart-btn">Th√™m v√†o gi·ªè h√†ng</button>
                        <button class="btn-buy-now" id="buy-now-btn">Mua ngay</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="reviews-container">
        <div class="reviews-header">
            <h3>ƒê√°nh gi√° & Nh·∫≠n x√©t</h3>
        </div>
        <div class="review-stats">
            <div><span id="avg-rating-display" class="big-star">0.0 ‚òÖ</span></div>
            <div class="total-reviews-display" id="total-reviews-display">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</div>
        </div>
        <div class="review-form-box">
            <h4>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h4>
            <div class="star-rating-input">
                <input type="radio" id="st5" name="rating" value="5"><label for="st5" title="5 sao">‚òÖ</label>
                <input type="radio" id="st4" name="rating" value="4"><label for="st4" title="4 sao">‚òÖ</label>
                <input type="radio" id="st3" name="rating" value="3"><label for="st3" title="3 sao">‚òÖ</label>
                <input type="radio" id="st2" name="rating" value="2"><label for="st2" title="2 sao">‚òÖ</label>
                <input type="radio" id="st1" name="rating" value="1"><label for="st1" title="1 sao">‚òÖ</label>
            </div>
            <textarea id="review-comment" class="review-textarea" placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n..."></textarea>
            <button onclick="ReviewSystem.submit()" class="btn-submit-review">G·ª≠i ƒë√°nh gi√°</button>
        </div>
        <div id="reviews-list"></div>
    </div>
    <div id="cart-popup">
        <h3 style="margin-top:0;">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
        <div class="cart-list" id="cart-list">
            <div style="color:#888">Gi·ªè h√†ng tr·ªëng</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>T·ªïng:</div>
            <div style="font-weight:700" id="cart-total">0‚Ç´</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
            <button class="cart-btn" id="checkout">Thanh to√°n</button>
            <button class="small-btn" id="clear-cart">X√≥a</button>
            <button class="small-btn" id="close-cart" style="margin-left:auto;">ƒê√≥ng</button>
        </div>
    </div>
    <div id="voice_popup" style="display:none;">
        <div class="voice-popup-content">
            <h5>üéôÔ∏è ƒêang nghe...</h5>
            <p>H√£y n√≥i t·ª´ kh√≥a t√¨m ki·∫øm c·ªßa b·∫°n</p>
            <p id="transcript_display" style="min-height: 25px; color: #1867f8; font-weight: bold; margin: 15px 0;"></p>
            <div class="listening-dot">‚Ä¢</div>
            <button type="button" onclick="cancelVoiceSearch()"
                style="padding:10px 20px; background:#666; color:white; border:none; border-radius:8px; cursor:pointer; margin-top:10px;">H·ªßy</button>
        </div>
    </div>
    <footer>
        <div class="footer">
            <div class="footer-section">
                <div class="footer-logo">
                    <h2 style="color:#00aaff; font-size:28px;">SHOPPY</h2>
                    <p style="color:#ccc;">Web b√°n h√†ng h√†ng ƒë·∫ßu Vi·ªát Nam.</p>
                </div>
                <h3>ƒê·ªëi t√°c thanh to√°n</h3>
                <div class="partners"><img src="images/payment/visa.png" alt="Visa"><img
                        src="images/payment/mastercard.png" alt="Mastercard"><img src="images/payment/momo.png"
                        alt="MoMo"><img src="images/payment/vnpay.jpg" alt="VNPay"><img src="images/payment/vietqr.png"
                        alt="VietQR"><img src="images/payment/mbbank.png" alt="MB Bank"><img
                        src="images/payment/viettinbank.png" alt="Viettinbank"></div>
            </div>
            <div class="footer-section">
                <h3>V·ªÅ Shoppy</h3>
                <ul>
                    <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                    <li><a href="#">Li√™n h·ªá</a></li>
                    <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
                    <li><a href="#">Tr·ª£ gi√∫p</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>S·∫£n ph·∫©m</h3>
                <ul>
                    <li><a href="#">ƒê·ªì d√πng h·ªçc t·∫≠p</a></li>
                    <li><a href="#">ƒê·ªì ƒëi·ªán t·ª≠</a></li>
                    <li><a href="#">Th·ªùi trang</a></li>
                    <li><a href="#">ƒê·ªì gia d·ª•ng</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Ch√≠nh s√°ch</h3>
                <ul>
                    <li><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
                    <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
                    <li><a href="#">ƒê·ªïi tr·∫£ & Ho√†n ti·ªÅn</a></li>
                </ul>
                <h3 style="margin-top:20px;">Theo d√µi ch√∫ng t√¥i</h3>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank"><img src="/images/icons/fb.jpg"
                            alt="Facebook"></a>
                    <a href="https://www.instagram.com" target="_blank"><img src="/images/icons/ins.jpg"
                            alt="Instagram"></a>
                    <a href="https://www.tiktok.com" target="_blank"><img src="/images/icons/tiktok.jpg"
                            alt="TikTok"></a>
                    <a href="https://www.youtube.com" target="_blank"><img src="/images/icons/youtube.png"
                            alt="YouTube"></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">@ 2025 Shoppy ‚Äî Khoa CNTT, HCMUS</div>
    </footer>
    <script>
        const API_BASE = '';
        const $ = sel => document.querySelector(sel);
        const $$ = sel => document.querySelectorAll(sel);
        let cart = JSON.parse(localStorage.getItem('cart_v1') || '{}');
        let currentProduct = null;
        let currentQuantity = 1;
        
        // --- B·ªî SUNG: D·ªØ li·ªáu t·∫•t c·∫£ s·∫£n ph·∫©m (t·ª´ API call b·ªï sung) ---
        let ALL_PRODUCTS = [];

        function formatMoney(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '‚Ç´'; }
        const renderStars = (rate) => {
            const rateFloat = parseFloat(rate) || 0;
            let output = '‚òÖ'.repeat(Math.floor(rateFloat));
            const decimalPart = rateFloat % 1;
            if (decimalPart >= 0.5) output += '¬Ω';
            output += '‚òÜ'.repeat(5 - (Math.floor(rateFloat) + (decimalPart >= 0.5 ? 1 : 0)));
            return output;
        };
        function saveCart() { localStorage.setItem('cart_v1', JSON.stringify(cart)); updateCartUI(); }
        function addToCart(productId, storeId, qty) {
            const key = `${productId}_${storeId}`;
            cart[key] = (cart[key] || 0) + qty;
            saveCart();
            alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
        }
        function changeQty(key, delta) {
            cart[key] = (cart[key] || 0) + delta;
            if (cart[key] <= 0) delete cart[key];
            saveCart();
        }
        function removeItem(key) { if (confirm("X√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) { delete cart[key]; saveCart(); } }

        // ======================================================================
        // H√ÄM B·ªî SUNG: T·∫¢I T·∫§T C·∫¢ S·∫¢N PH·∫®M (M√¥ ph·ªèng logic t·ª´ index.html)
        // ======================================================================
        async function loadAllProducts() {
            try {
                // T·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m (kh√¥ng filter)
                const res = await fetch(`${API_BASE}/api/products`);
                ALL_PRODUCTS = await res.json();
                console.log(`ƒê√£ t·∫£i ${ALL_PRODUCTS.length} s·∫£n ph·∫©m cho gi·ªè h√†ng.`);
            } catch (err) {
                console.error("L·ªói khi load ALL_PRODUCTS:", err);
                // Gi·∫£ ƒë·ªãnh d·ªØ li·ªáu ƒë·ªÉ Gi·ªè h√†ng v·∫´n ho·∫°t ƒë·ªông (n·∫øu API l·ªói)
                if (ALL_PRODUCTS.length === 0 && currentProduct) {
                    ALL_PRODUCTS.push({
                        product_id: currentProduct.product_id,
                        product_name: currentProduct.name,
                        product_image_url: currentProduct.img,
                        stores: [{
                            store_id: currentProduct.store_id,
                            store_name: currentProduct.sub_name,
                            min_price: currentProduct.price,
                            product_images: [{ ps_type: 1, ps_image_url: currentProduct.img }]
                        }]
                    });
                }
            }
        }


        // ======================================================================
        // H√ÄM T√åM TH√îNG TIN S·∫¢N PH·∫®M TRONG GI·ªé H√ÄNG (D·ª±a tr√™n ALL_PRODUCTS)
        // ======================================================================
        function getCartItemDetails(productId, storeId) {
            
            // 1. T√¨m s·∫£n ph·∫©m ch√≠nh trong danh s√°ch t·ªïng
            const product = ALL_PRODUCTS.find(p => p.product_id == productId);

            if (product) {
                // 2. T√¨m c·ª≠a h√†ng c·ª• th·ªÉ trong s·∫£n ph·∫©m ƒë√≥
                const store = product.stores.find(s => s.store_id == storeId);
                
                if (store) {
                    // L·∫•y ·∫£nh ch√≠nh c·ªßa c·ª≠a h√†ng (ps_type = 1), n·∫øu kh√¥ng c√≥ th√¨ d√πng ·∫£nh s·∫£n ph·∫©m
                    const mainImage = store.product_images ? store.product_images.find(img => img.ps_type === 1) : null;
                    const storeImageUrl = mainImage ? mainImage.ps_image_url : product.product_image_url;
                    
                    return {
                        name: product.product_name,
                        store_name: store.store_name,
                        price: store.min_price || store.cost || 0,
                        img: storeImageUrl
                    };
                }
            }

            // N·∫øu kh√¥ng t√¨m th·∫•y
            return {
                name: `S·∫£n ph·∫©m #${productId}`,
                store_name: `C·ª≠a h√†ng #${storeId}`,
                price: 0,
                img: 'images/placeholder.jpg'
            };
        }


        // ======================================================================
        // H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN GI·ªé H√ÄNG (S·ª¨ D·ª§NG getCartItemDetails)
        // ======================================================================
        function updateCartUI() {

            const cartList = $('#cart-list');
            const cartCount = Object.values(cart).reduce((s, q) => s + q, 0);
            let total = 0;
            
            // Badge s·ªë l∆∞·ª£ng gi·ªè h√†ng
            const cartCountBubble = $('#cart-count');
            if (cartCountBubble) {
                cartCountBubble.textContent = cartCount;
                cartCountBubble.style.display = cartCount > 0 ? 'block' : 'none';
            }

            // N·∫øu gi·ªè h√†ng r·ªóng
            if (cartCount === 0) {
                if (cartList) cartList.innerHTML = '<div style="color:#888">Gi·ªè h√†ng tr·ªëng</div>';
                if ($('#cart-total')) $('#cart-total').textContent = formatMoney(0);
                return;
            }

            // Render t·ª´ng item trong gi·ªè
            if (cartList) {
                cartList.innerHTML = '';

                Object.entries(cart).forEach(([key, qty]) => {
                    const [productId, storeId] = key.split('_');

                    // L·∫•y th√¥ng tin chi ti·∫øt s·∫£n ph·∫©m (D√πng ALL_PRODUCTS)
                    const itemDetails = getCartItemDetails(productId, storeId);

                    const price = itemDetails.price || 0;
                    total += price * qty;

                    const item = document.createElement('div');
                    item.className = 'cart-item';

                    item.innerHTML = `
                        <img src="${itemDetails.img}" />

                        <div style="flex:1">
                            <div style="font-size:14px">${itemDetails.name}</div>
                            <div style="font-size:12px;color:#666">${itemDetails.store_name}</div>
                            <div style="font-size:13px;color:#666">
                                ${formatMoney(price)} x ${qty} = ${formatMoney(price * qty)}
                            </div>
                        </div>

                        <div class="qty">
                            <button class="small-btn" onclick="changeQty('${key}', -1)">-</button>
                            <div style="min-width:20px;text-align:center">${qty}</div>
                            <button class="small-btn" onclick="changeQty('${key}', 1)">+</button>

                            <button class="small-btn" style="margin-left:6px" onclick="removeItem('${key}')">x√≥a</button>
                        </div>
                    `;

                    cartList.appendChild(item);
                });
            }

            if ($('#cart-total')) $('#cart-total').textContent = formatMoney(total);
        }
        // ======================================================================


        function updateAccountLink() {
            const accountLink = document.getElementById('account-link');
            const userName = localStorage.getItem('userName');
            const logoutLink = document.getElementById('logout-link');
            if (accountLink) {
                if (userName) {
                    accountLink.textContent = userName;
                    accountLink.href = 'account.html';
                    if (logoutLink) logoutLink.style.display = 'flex';
                } else {
                    accountLink.textContent = 'T√†i Kho·∫£n';
                    accountLink.href = 'account.html';
                    if (logoutLink) logoutLink.style.display = 'none';
                }
            }
        }
        async function lookupPsId(product_id, store_id) {
            try {
                const res = await fetch(`${API_BASE}/api/ps_id_lookup?product_id=${product_id}&store_id=${store_id}`);
                if (!res.ok) throw new Error('Kh√¥ng t√¨m th·∫•y ps_id');
                const data = await res.json();
                return data.ps_id;
            } catch (error) { console.error("L·ªói tra c·ª©u PS_ID:", error); return null; }
        }
        async function loadMainProduct() {
            const params = new URLSearchParams(window.location.search);
            const product_id = params.get('product_id'), store_id = params.get('store_id');
            if (!product_id || !store_id) { document.body.innerHTML = '<h2 style="padding:20px">Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m ho·∫∑c C·ª≠a h√†ng</h2>'; return; }
            const ps_id = await lookupPsId(product_id, store_id);
            if (!ps_id) { document.body.innerHTML = '<h2 style="padding:20px">Kh√¥ng t√¨m th·∫•y t·ªï h·ª£p s·∫£n ph·∫©m v√† c·ª≠a h√†ng (ps_id)</h2>'; return; }
            let productDetails = null;
            try {
                const res = await fetch(`${API_BASE}/api/product_detail/${ps_id}`);
                if (res.ok) productDetails = await res.json();
                else throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt s·∫£n ph·∫©m.");
            } catch (err) { console.error("L·ªói t·∫£i product_detail:", err); document.body.innerHTML = '<h2 style="padding:20px">L·ªói t·∫£i d·ªØ li·ªáu chi ti·∫øt s·∫£n ph·∫©m.</h2>'; return; }
            if (productDetails) {
                currentProduct = {
                    id: productDetails.id, product_id: productDetails.product_id, store_id: productDetails.store_id,
                    name: productDetails.sub_name, sub_name: productDetails.name, address: productDetails.address,
                    price: productDetails.price, img: productDetails.img, description: productDetails.description,
                    rating: productDetails.rating, review_count: productDetails.review_count
                };
                $('#product-name').textContent = currentProduct.name;
                document.getElementById('product-subtitle').innerHTML = `<div><strong>C·ª≠a h√†ng:</strong> ${currentProduct.sub_name}</div><div style="font-size: 0.9em; color: #777;">üìç ${currentProduct.address || ''}</div>`;
                $('#product-price').textContent = formatMoney(currentProduct.price);
                $('#product-image-main').src = currentProduct.img || '/images/placeholder.jpg';
                $('#product-description').textContent = currentProduct.description;
                const rating = currentProduct.rating || 0;
                // --- CH·ªàNH S·ª¨A T·∫†I ƒê√ÇY ---
                const ratingText = `<span style="font-weight:700;">${rating.toFixed(1)}</span> <span class="stars" style="color:#facc15;">‚òÖ</span>`; // Ch·ªâ hi·ªÉn th·ªã ƒëi·ªÉm v√† m·ªôt ng√¥i sao
                $('#selected-store-detail').innerHTML = `<div class="store-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;"><div><div class="store-name" style="font-weight:600; font-size:16px;">${currentProduct.sub_name}</div><div class="store-dist" style="font-size:14px; color:#555;">ƒê·ªãa ch·ªâ: ${currentProduct.address || 'ƒêang c·∫≠p nh·∫≠t'}</div></div><div class="store-rating" style="text-align:right;">${ratingText} <span class="reviews" style="font-size:14px; color:#888;">(${currentProduct.review_count || 0} ƒê√°nh gi√°)</span></div></div>`;
                // --------------------------
                ReviewSystem.load(currentProduct.id);
            } else { document.body.innerHTML = '<h2 style="padding:20px">L·ªói: Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt s·∫£n ph·∫©m.</h2>'; return; }
        }
        const ReviewSystem = {
            load: async function (ps_id) {
                try {
                    const res = await fetch(`${API_BASE}/api/reviews/${ps_id}`);
                    const data = await res.json();
                    document.getElementById('avg-rating-display').innerText = `${data.average_rating.toFixed(1)} ‚òÖ`;
                    document.getElementById('total-reviews-display').innerText = `${data.total_reviews} ƒë√°nh gi√°`;
                    const list = document.getElementById('reviews-list');
                    list.innerHTML = '';
                    if (data.reviews.length === 0) { list.innerHTML = '<p style="color:#888;text-align:center">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>'; return; }
                    data.reviews.forEach(r => {
                        const stars = renderStars(r.rating);
                        const date = new Date(r.created_at).toLocaleDateString('vi-VN');
                        list.innerHTML += `<div class="review-item"><div class="review-avatar">U#${r.user_id}</div><div class="review-content"><span class="review-author">User #${r.user_id}</span><div class="review-stars-static">${stars}</div><div class="review-text">${r.comment}</div><div class="review-time">${date}</div></div></div>`;
                    });
                } catch (e) { console.warn("L·ªói t·∫£i reviews:", e); }
            },
            submit: async function () {
                const comment = document.getElementById('review-comment').value;
                const ratingEl = document.querySelector('input[name="rating"]:checked');
                if (!ratingEl) { alert("Vui l√≤ng ch·ªçn sao!"); return; }
                if (!currentProduct || !currentProduct.id) { alert("L·ªói: Ch∆∞a t·∫£i ƒë∆∞·ª£c s·∫£n ph·∫©m"); return; }
                const payload = { ps_id: currentProduct.id, user_id: 1, rating: parseInt(ratingEl.value), comment: comment };
                try {
                    const res = await fetch(`${API_BASE}/api/reviews`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.ok) { alert("ƒê√£ g·ª≠i ƒë√°nh gi√°!"); document.getElementById('review-comment').value = ''; await loadMainProduct(); } else alert("L·ªói g·ª≠i ƒë√°nh gi√°.");
                } catch (e) { alert("L·ªói k·∫øt n·ªëi Server."); }
            }
        };
        let currentRecognition = null;
        window.toggleFilterMenu = function () { $('#filter-dropdown').classList.toggle('active'); }
        window.startVoiceSearch = function () { alert("T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i ch∆∞a ƒë∆∞·ª£c t√≠ch h·ª£p tr√™n trang n√†y."); }
        window.cancelVoiceSearch = function () { if (currentRecognition) currentRecognition.abort(); $('#voice_popup').style.display = "none"; }
        
        // ======================================================================
        // C·∫¨P NH·∫¨T DOMContentLoaded: CH·∫†Y loadAllProducts() TR∆Ø·ªöC
        // ======================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            // B∆∞·ªõc 1: T·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m
            await loadAllProducts(); 
            
            // B∆∞·ªõc 2: T·∫£i s·∫£n ph·∫©m chi ti·∫øt c·ªßa trang hi·ªán t·∫°i
            await loadMainProduct();
            
            // B∆∞·ªõc 3: C·∫≠p nh·∫≠t Gi·ªè h√†ng (d√πng d·ªØ li·ªáu ƒë√£ t·∫£i)
            updateCartUI();
            
            updateAccountLink();

            $('#qty-input').value = currentQuantity;
            $('#qty-minus').onclick = () => { if (currentQuantity > 1) $('#qty-input').value = --currentQuantity; };
            $('#qty-plus').onclick = () => { $('#qty-input').value = ++currentQuantity; };
            $('#add-to-cart-btn').onclick = () => {
                if (currentProduct && currentProduct.product_id && currentProduct.store_id) addToCart(currentProduct.product_id, currentProduct.store_id, currentQuantity);
                else alert('L·ªói: Thi·∫øu th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o gi·ªè h√†ng.');
            };
            $('#buy-now-btn').onclick = () => {
                if (currentProduct && currentProduct.product_id && currentProduct.store_id) {
                    addToCart(currentProduct.product_id, currentProduct.store_id, currentQuantity);
                    document.body.classList.add('page-fade-out');
                    setTimeout(() => { window.location.href = 'cart.html'; }, 500);
                } else alert('L·ªói: Thi·∫øu th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ mua ngay.');
            };
            $('#search_form').onsubmit = (e) => {
                e.preventDefault();
                document.body.classList.add('page-fade-out');
                setTimeout(() => { window.location.href = `index.html?search=${$('#search_input').value}`; }, 500);
            };
            $('#open-cart').onclick = () => { const popup = $('#cart-popup'); popup.style.display = (popup.style.display === 'block') ? 'none' : 'block'; };
            $('#close-cart').onclick = () => $('#cart-popup').style.display = 'none';
            $('#clear-cart').onclick = () => { if (confirm('X√≥a to√†n b·ªô gi·ªè h√†ng?')) { cart = {}; saveCart(); } };
            $('#checkout').onclick = () => { document.body.classList.add('page-fade-out'); setTimeout(() => { window.location.href = 'cart.html'; }, 500); };
            if ($('#logout-link')) {
                $('#logout-link').addEventListener('click', () => {
                    localStorage.removeItem('accessToken'); localStorage.removeItem('userName');
                    document.body.classList.add('page-fade-out');
                    setTimeout(() => { window.location.href = 'index.html'; }, 500);
                });
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        div { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        h2 { margin-top: 0; }
        input { display: block; margin-bottom: 10px; width: 300px; padding: 8px; }
        button { padding: 10px 15px; cursor: pointer; }
        pre { background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>

    <h1>Test API Đăng ký / Đăng nhập</h1>

    <div>
        <h2>1. Đăng ký</h2>
        <form id="register-form">
            <input type="text" id="reg-name" placeholder="Tên" required>
            <input type="email" id="reg-email" placeholder="Email" required>
            <input type="password" id="reg-pwd" placeholder="Mật khẩu (pwd)" required>
            <button type="submit">Đăng ký</button>
        </form>
    </div>

    <div>
        <h2>2. Đăng nhập</h2>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-pwd" placeholder="Mật khẩu (pwd)" required>
            <button type="submit">Đăng nhập</button>
        </form>
    </div>

    <div>
        <h2>3. Test (Route được bảo vệ)</h2>
        <button id="profile-button">Lấy Profile (Cần Đăng nhập trước)</button>
        <button id="refresh-button">Làm mới Token (Cần Đăng nhập trước)</button>
        
        <button id="logout-button" style="background-color: #ffdddd;">Đăng xuất</button>
    </div>

    <h2>Kết quả:</h2>
    <pre id="output">Chưa có hành động nào...</pre>

    <script>
        // Nơi lưu trữ token sau khi đăng nhập
        let accessToken = null;
        let refreshToken = null;

        const outputEl = document.getElementById('output');
        const API_URL = 'http://127.0.0.1:5000'; // Địa chỉ server Flask

        // Hàm helper để hiển thị kết quả
        function showOutput(data) {
            outputEl.textContent = JSON.stringify(data, null, 2);
        }

        // 1. XỬ LÝ ĐĂNG KÝ
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault(); // Ngăn form gửi đi
            
            const data = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                pwd: document.getElementById('reg-pwd').value
            };

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showOutput(result);
            } catch (error) {
                showOutput({ error: error.message });
            }
        });

        // 2. XỬ LÝ ĐĂNG NHẬP
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                email: document.getElementById('login-email').value,
                pwd: document.getElementById('login-pwd').value
            };

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // LƯU TOKEN lại nếu đăng nhập thành công
                    accessToken = result.access_token;
                    refreshToken = result.refresh_token;
                    showOutput({ msg: 'Đăng nhập thành công! Đã lưu token.', tokens: result });
                } else {
                    showOutput(result); // Hiển thị lỗi, ví dụ: "Sai mật khẩu"
                }
            } catch (error) {
                showOutput({ error: error.message });
            }
        });

        // 3. XỬ LÝ LẤY PROFILE (DÙNG ACCESS TOKEN)
        document.getElementById('profile-button').addEventListener('click', async function() {
            if (!accessToken) {
                showOutput({ msg: 'Lỗi: Bạn chưa đăng nhập (không có access_token)' });
                return;
            }

            try {
                const response = await fetch(`${API_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const result = await response.json();
                showOutput(result);
            } catch (error) {
                showOutput({ error: error.message });
            }
        });
        
        // 4. XỬ LÝ LÀM MỚI TOKEN (DÙNG REFRESH TOKEN)
        document.getElementById('refresh-button').addEventListener('click', async function() {
            if (!refreshToken) {
                showOutput({ msg: 'Lỗi: Bạn chưa đăng nhập (không có refresh_token)' });
                return;
            }

            try {
                const response = await fetch(`${API_URL}/refresh`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${refreshToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Cập nhật lại access token mới
                    accessToken = result.access_token;
                    showOutput({ msg: 'Làm mới token thành công!', new_token: result });
                } else {
                    showOutput(result);
                }
            } catch (error) {
                showOutput({ error: error.message });
            }
        });

        // 5. XỬ LÝ ĐĂNG XUẤT (DÙNG REFRESH TOKEN)
        document.getElementById('logout-button').addEventListener('click', async function() {
            if (!refreshToken) {
                showOutput({ msg: 'Lỗi: Bạn chưa đăng nhập (không có refresh_token)' });
                return;
            }

            try {
                const response = await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${refreshToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // XÓA TOKEN Ở CLIENT
                    accessToken = null;
                    refreshToken = null;
                    showOutput({ msg: 'Đăng xuất thành công! Đã xóa token ở client.' });
                } else {
                    showOutput(result);
                }
            } catch (error) {
                showOutput({ error: error.message });
            }
        });
    </script>
</body>
</html>
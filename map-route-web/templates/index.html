<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Smart Shopping Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #3b82f6;
      --store-bg: #f97316;
      --text-main: #1e293b;
      --text-light: #64748b;
      --bg-panel: rgba(255, 255, 255, 0.95);
      --radius: 12px;
    }

    html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
    #map { width: 100%; height: 100%; z-index: 0; }

    /* --- 1. Control Panel (Gi·ªØ nguy√™n) --- */
    .control-panel {
      position: absolute; top: 20px; left: 20px; width: 320px;
      background: var(--bg-panel); padding: 20px; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 1000;
      backdrop-filter: blur(8px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255,255,255,0.6);
    }
    .control-panel.collapsed { transform: translateX(calc(-100% - 30px)); }

    .toggle-btn {
      position: absolute; right: -28px; top: 20px; width: 28px; height: 32px;
      background: white; border: 1px solid #e2e8f0; border-left: none;
      border-radius: 0 8px 8px 0; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); color: var(--text-light);
    }
    .toggle-btn:hover { color: var(--primary); }

    .brand { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin-bottom: 15px; display: flex; align-items: center; gap:8px;}
    .input-group { margin-bottom: 12px; }
    .label { font-size: 0.7rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; display: block;}
    
    select, input[type="text"] {
      width: 100%; padding: 9px 10px; border-radius: 8px; border: 1px solid #cbd5e1;
      background: #fff; font-size: 0.85rem; color: var(--text-main); outline: none; box-sizing: border-box;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    select:focus, input:focus { border-color: var(--primary); }
    input[readonly] { background: #f1f5f9; color: #64748b; cursor: default; }

    .btn-draw {
      width: 100%; background: var(--primary); color: white; border: none; padding: 10px;
      border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: 0.2s; margin-top: 8px;
    }
    .btn-draw:hover { background: #2563eb; }
    
    .status-bar { margin-top: 10px; font-size: 0.8rem; text-align: center; color: var(--text-light); min-height: 18px;}
    .route-result { background: #eff6ff; color: #1e40af; padding: 8px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; text-align: center; margin-top: 8px; display: none; border: 1px solid #bfdbfe;}

    /* --- 2. Layer Switcher (NEW) --- */
    .layer-control {
      position: absolute;
      bottom: 100px; /* N·∫±m tr√™n n√∫t Zoom (Zoom th∆∞·ªùng ·ªü bottom: 20-30px) */
      right: 10px;
      z-index: 900;
      display: flex;
      flex-direction: row-reverse; /* Icon ch√≠nh b√™n ph·∫£i, menu s·ªï sang tr√°i */
      align-items: center;
      gap: 8px;
    }

    /* N√∫t ch√≠nh (Icon Layer) */
    .layer-btn-main {
      width: 44px; height: 44px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: #333;
      border: 2px solid white; /* Border gi·∫£ ƒë·ªÉ kh·ªõp style map */
      transition: all 0.2s;
    }
    .layer-btn-main:hover { background: #f8fafc; color: var(--primary); }

    /* Menu ch·ª©a c√°c n√∫t ch·ªçn (·∫®n m·∫∑c ƒë·ªãnh) */
    .layer-options {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.95);
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      
      /* Animation S·ªï Ngang */
      max-width: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s ease-in-out;
      transform-origin: right center;
    }

    /* Khi hover v√†o container cha th√¨ hi·ªán menu */
    .layer-control:hover .layer-options {
      max-width: 300px; /* ƒê·ªß r·ªông ƒë·ªÉ ch·ª©a 3 n√∫t */
      opacity: 1;
      padding: 5px 8px; /* Tr·∫£ l·∫°i padding */
    }

    /* C√°c n√∫t option con */
    .layer-opt {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      color: var(--text-light);
      border: 1px solid transparent;
    }
    .layer-opt:hover { background: #f1f5f9; color: var(--primary); }
    .layer-opt.active { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; }


    /* --- 3. Marker Styles --- */
    .marker-pin {
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: all 0.3s ease; border: 1.5px solid white;
    }
    .store-marker { background: var(--store-bg); opacity: 0.9; }
    .map-zoomed-in .store-marker { width: 26px; height: 26px; font-size: 13px; }
    .map-zoomed-out .store-marker { width: 8px !important; height: 8px !important; font-size: 0; margin-left: 9px; margin-top: 9px; border-width: 1px; opacity: 0.8; }
    .user-marker { background: var(--primary); z-index: 1000; }
    .map-zoomed-in .user-marker { width: 28px; height: 28px; font-size: 14px; }
    .map-zoomed-out .user-marker { width: 10px !important; height: 10px !important; margin-left: 9px; margin-top: 9px; border-width: 2px; }

    /* Popup & Loading */
    .popup-content { text-align: center; width: 200px; }
    .popup-content h3 { margin: 0 0 4px 0; font-size: 0.95rem; color: var(--text-main); }
    .popup-content p { margin: 0 0 10px 0; font-size: 0.8rem; color: var(--text-light); }
    .btn-select { width: 100%; padding: 6px; background: white; border: 1px solid var(--primary); color: var(--primary); border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s;}
    .btn-select:hover { background: var(--primary); color: white; }
    #loading { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.95); padding:15px 25px; border-radius:50px; box-shadow:0 5px 20px rgba(0,0,0,0.1); z-index:2000; font-weight:600; color: var(--primary); align-items:center; gap:10px; backdrop-filter: blur(4px); border: 1px solid #e2e8f0;}
    .spin { animation: spin 1s linear infinite; width: 18px; height: 18px; border: 2px solid #cbd5e1; border-top-color: var(--primary); border-radius: 50%; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="control-panel" id="panel">
    <div class="toggle-btn" id="toggle-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
    <div class="brand"><span style="font-size: 1.2rem;">üè∑Ô∏è</span> Shopping Map</div>

    <div class="input-group">
      <label class="label">B·∫Øt ƒë·∫ßu</label>
      <select id="start-select">
        <option value="default">üè´ KTX 135B Tr·∫ßn H∆∞ng ƒê·∫°o</option>
        <option value="gps">üìç V·ªã tr√≠ hi·ªán t·∫°i (GPS)</option>
      </select>
      <input type="hidden" id="start-coords" value="106.69367,10.76128">
    </div>
    <div class="input-group">
      <label class="label">ƒê√≠ch ƒë·∫øn</label>
      <input id="end-display" type="text" placeholder="Ch·ªçn tr√™n b·∫£n ƒë·ªì..." readonly />
      <input type="hidden" id="end-coords">
    </div>
    <div class="input-group">
      <label class="label">Ph∆∞∆°ng ti·ªán</label>
      <select id="profile-select">
        <option value="driving-car">üöó √î t√¥</option>
        <option value="cycling-regular">üö¥ Xe ƒë·∫°p</option>
        <option value="foot-walking">üö∂ ƒêi b·ªô</option>
      </select>
    </div>
    <button class="btn-draw" id="btn-draw">V·∫Ω ƒë∆∞·ªùng ƒëi</button>
    <div class="status-bar" id="status-text">S·∫µn s√†ng</div>
    <div class="route-result" id="route-result"></div>
  </div>

  <div class="layer-control">
    <div class="layer-btn-main" title="ƒê·ªïi l·ªõp b·∫£n ƒë·ªì">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
    </div>
    <div class="layer-options">
      <div class="layer-opt active" onclick="switchLayer('street', this)">ƒê∆∞·ªùng Ph·ªë</div>
      <div class="layer-opt" onclick="switchLayer('satellite', this)">V·ªá tinh</div>
      <div class="layer-opt" onclick="switchLayer('terrain', this)">ƒê·ªãa h√¨nh</div>
    </div>
  </div>

  <div id="map"></div>
  <div id="loading"><div class="spin"></div><span>ƒêang x·ª≠ l√Ω...</span></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- 1. Map & Layers Setup ---
    
    // ƒê·ªãnh nghƒ©a c√°c Tiles
    const layers = {
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '¬© OpenStreetMap'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18, attribution: 'Tiles ¬© Esri'
        }),
        terrain: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18, attribution: 'Tiles ¬© Esri'
        })
    };

    // Kh·ªüi t·∫°o Map v·ªõi layer m·∫∑c ƒë·ªãnh l√† 'street'
    const map = L.map('map', { zoomControl: false, layers: [layers.street] }).setView([10.762622, 106.660172], 13);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // H√†m chuy·ªÉn ƒë·ªïi Layer
    window.switchLayer = function(type, el) {
        // X√≥a t·∫•t c·∫£ layer c≈©
        for (let key in layers) {
            map.removeLayer(layers[key]);
        }
        // Th√™m layer m·ªõi
        map.addLayer(layers[type]);
        
        // C·∫≠p nh·∫≠t UI active
        document.querySelectorAll('.layer-opt').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
    };

    // --- Zoom UI Logic ---
    const mapContainer = document.getElementById('map');
    function updateZoomClass() {
        const zoom = map.getZoom();
        if (zoom >= 14) {
            mapContainer.classList.add('map-zoomed-in');
            mapContainer.classList.remove('map-zoomed-out');
        } else {
            mapContainer.classList.add('map-zoomed-out');
            mapContainer.classList.remove('map-zoomed-in');
        }
    }
    updateZoomClass();
    map.on('zoomend', updateZoomClass);

    // --- 2. Toggle Panel ---
    const panel = document.getElementById('panel');
    const toggleBtn = document.getElementById('toggle-btn');
    toggleBtn.onclick = () => {
        panel.classList.toggle('collapsed');
        toggleBtn.querySelector('svg').innerHTML = panel.classList.contains('collapsed') 
            ? '<polyline points="9 18 15 12 9 6"></polyline>' 
            : '<polyline points="15 18 9 12 15 6"></polyline>';
    };

    // --- 3. Marker Logic ---
    function createMarker(type, lat, lng) {
        const iconClass = type === 'store' ? 'store-marker' : 'user-marker';
        const emoji = type === 'store' ? 'üçú' : 'üè†';
        const icon = L.divIcon({
            className: 'custom-div-icon', 
            html: `<div class="marker-pin ${iconClass}">${emoji}</div>`,
            iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -14]
        });
        return L.marker([lat, lng], {icon: icon});
    }

    // --- 4. Core App Logic ---
    const startSelect = document.getElementById('start-select');
    const startCoordsHidden = document.getElementById('start-coords');
    const endDisplay = document.getElementById('end-display');
    const endCoordsHidden = document.getElementById('end-coords');
    const btnDraw = document.getElementById('btn-draw');
    const statusText = document.getElementById('status-text');
    const routeResult = document.getElementById('route-result');
    const loading = document.getElementById('loading');

    let routeLayer = null;
    let userMarker = null;
    const defaultCoords = [10.76128, 106.69367]; 

    // Marker User
    userMarker = createMarker('user', defaultCoords[0], defaultCoords[1]).addTo(map);
    userMarker.bindPopup("<b>ƒêi·ªÉm xu·∫•t ph√°t</b><br>KTX 135B Tr·∫ßn H∆∞ng ƒê·∫°o");

    startSelect.addEventListener('change', (e) => {
        if(e.target.value === 'default') {
            startCoordsHidden.value = `${defaultCoords[1]},${defaultCoords[0]}`;
            userMarker.setLatLng(defaultCoords).bindPopup("<b>ƒêi·ªÉm xu·∫•t ph√°t</b><br>KTX 135B Tr·∫ßn H∆∞ng ƒê·∫°o").openPopup();
            map.setView(defaultCoords, 14);
        } else {
            loading.style.display = 'flex';
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                startCoordsHidden.value = `${lng},${lat}`;
                userMarker.setLatLng([lat, lng]).bindPopup("<b>V·ªã tr√≠ c·ªßa b·∫°n</b>").openPopup();
                map.setView([lat, lng], 15);
                loading.style.display = 'none';
            }, err => {
                alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS.");
                startSelect.value = 'default';
                loading.style.display = 'none';
            });
        }
    });

    async function loadStores() {
        try {
            const res = await fetch('/api/stores');
            const stores = await res.json();
            stores.forEach(s => {
                if (s.lat && s.long) {
                    const marker = createMarker('store', s.lat, s.long).addTo(map);
                    const popupContent = document.createElement('div');
                    popupContent.className = 'popup-content';
                    popupContent.innerHTML = `<h3>${s.name}</h3><p>${s.address || ''}</p>`;
                    const btn = document.createElement('button');
                    btn.className = 'btn-select';
                    btn.innerText = 'üö© ƒê·∫øn ƒë√¢y';
                    btn.onclick = () => {
                        const displayAddr = s.address ? `${s.name} - ${s.address}` : s.name;
                        endDisplay.value = displayAddr; endDisplay.title = displayAddr;
                        endCoordsHidden.value = `${s.long},${s.lat}`;
                        marker.closePopup();
                        if(panel.classList.contains('collapsed')) toggleBtn.click();
                        statusText.innerText = "ƒê√£ ch·ªçn ƒëi·ªÉm ƒë·∫øn.";
                    };
                    popupContent.appendChild(btn);
                    marker.bindPopup(popupContent);
                }
            });
        } catch(e) {}
    }

    btnDraw.onclick = async () => {
        const start = parseCoord(startCoordsHidden.value);
        const end = parseCoord(endCoordsHidden.value);
        const profile = document.getElementById('profile-select').value;
        if(!start || !end) { alert("Ch∆∞a ch·ªçn ƒë·ªãa ƒëi·ªÉm!"); return; }

        loading.style.display = 'flex';
        routeResult.style.display = 'none';
        try {
            const res = await fetch('/route', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ start, end, profile })
            });
            const geojson = await res.json();
            if(routeLayer) map.removeLayer(routeLayer);
            if(geojson.features && geojson.features.length > 0) {
                routeLayer = L.geoJSON(geojson, {
                    style: { color: '#3b82f6', weight: 5, opacity: 0.8, lineCap: 'round' }
                }).addTo(map);
                map.fitBounds(routeLayer.getBounds(), {padding:[50,50]});
                const s = geojson.features[0].properties.summary;
                routeResult.innerHTML = `${(s.distance/1000).toFixed(1)} km ‚Ä¢ ${Math.ceil(s.duration/60)} ph√∫t`;
                routeResult.style.display = 'block';
                statusText.innerText = "Ho√†n t·∫•t!";
            } else { statusText.innerText = "Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng."; }
        } catch(e) { alert("L·ªói Server"); } 
        finally { loading.style.display = 'none'; }
    };
    function parseCoord(str){ return str ? str.split(',').map(Number) : null; }
    loadStores();
  </script>
</body>
</html>
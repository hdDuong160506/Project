<!doctype html>
<html lang="vi">

<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>T·ªïng quan s·∫£n ph·∫©m - SHOPPY</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* CSS d√†nh ri√™ng cho trang Summary */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Inter, system-ui, "Segoe UI", Roboto, Arial;
            line-height: 1.4;
            color: #333;
            background: #f0f2f5;
            animation: pageFadeIn 0.5s ease-in-out;
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .breadcrumb {
            padding: 15px 60px;
            font-size: 14px;
            background: #e9ecef;
            /* C·∫ßn ƒëi·ªÅu ch·ªânh margin-top ƒë·ªÉ tr√°nh navbar fixed */
            margin-top: 130px; 
        }

        .breadcrumb a {
            color: #00aaff;
            text-decoration: none;
        }

        main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            min-height: 50vh; /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng qu√° ng·∫Øn */
        }

        .product-summary-col {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .product-detail-summary {
            flex: 1;
            min-width: 350px;
        }

        .store-list-recommend {
            flex: 1.5;
            min-width: 500px;
        }

        .product-detail-summary h2 {
            font-size: 30px;
            color: #00aaff;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .product-image-main {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .product-tag {
            background: #eef3ff;
            color: #00aaff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 10px;
        }

        .store-list-recommend h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .store-item-card {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none; /* B·ªè g·∫°ch ch√¢n cho th·∫ª <a> */
            color: inherit;
        }

        .store-item-card:hover {
            border-color: #00aaff;
            box-shadow: 0 2px 8px rgba(0, 170, 255, 0.2);
            transform: translateY(-2px);
        }

        .store-item-card img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .store-info {
            flex-grow: 1;
        }

        .store-name {
            font-weight: 600;
            font-size: 18px;
            color: #0b38cc;
        }

        .store-price {
            font-size: 15px;
            color: #ff4444;
            font-weight: 700;
            margin-top: 5px;
        }

        .store-review {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        .store-actions button {
            background: #0b38cc;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .store-actions button:hover {
            background: #5a6fcf;
        }

        .no-stores {
            padding: 40px;
            text-align: center;
            color: #888;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="navbar-top">
            <div class="nav-links-left">
                <a href="#">K√™nh Ng∆∞·ªùi B√°n</a>
                <span>|</span>
                <a href="#">Tr·ªü th√†nh Ng∆∞·ªùi b√°n Shoppy</a>
            </div>
            <div class="nav-links-right" style="display: flex; align-items: center; gap: 12px;">
                <a href="#">‚ùì H·ªó Tr·ª£</a>

                <a href="account.html" class="auth-link" id="account-link">T√†i Kho·∫£n</a>

                <div id="logout-link" title="ƒêƒÉng Xu·∫•t" style="margin-left: 8px; cursor: pointer; display: none;"
                    onclick="handleLogout()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"
                        fill="#FFFFFF">
                        <path
                            d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-240-56-56 94-94H440v-80h238l-94-94 56-56 200 200-200 200Z" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="navbar-main">
            <div class="nav-left">
                <a href="index.html" class="brand-link">
                    <img src="images/logo/logo1.png" alt="Logo" class="brand-logo">
                    <div class="brand">SHOPPY</div>
                </a>
            </div>

            <div class="nav-center-search">
                <form id="search_form" onsubmit="event.preventDefault();">

                    <div class="search-icon-left" title="B·ªô l·ªçc t√¨m ki·∫øm" onclick="toggleFilterMenu()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="#5f6368">
                            <path
                                d="M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Zm40-308 198-252H282l198 252Zm0 0Z" />
                        </svg>
                    </div>

                    <input type="text" name="search" id="search_input" placeholder="T√¨m ki·∫øm tr√™n Shoppy..."
                        autocomplete="off" />

                    <div class="search-actions-right">
                        <button type="button" onclick="openImageSearch()" class="icon-btn" title="T√¨m b·∫±ng h√¨nh ·∫£nh">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#5f6368">
                                <path
                                    d="M200-200h560q33 0 56.5-23.5T840-280v-480q0-33-23.5-56.5T760-840H200q-33 0-56.5 23.5T120-760v480q0 33 23.5 56.5T200-200Zm0-80v-480h560v480H200Zm40-80 140-180 100 120 160-200 160 240H240Zm-40 80h560-560Z" />
                            </svg>
                        </button>

                        <button type="button" onclick="startVoiceSearch()" class="icon-btn" title="T√¨m b·∫±ng gi·ªçng n√≥i">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#5f6368">
                                <path
                                    d="M480-400q-50 0-85-35t-35-85v-240q0-50 35-85t85-35q50 0 85 35t35 85v240q0 50-35 85t-85 35Zm0-240Zm-40 520v-123q-104-14-172-93t-68-184h80q0 83 58.5 141.5T480-320q83 0 141.5-58.5T680-520h80q0 105-68 184t-172 93v123h-80Zm40-360q17 0 28.5-11.5T520-520v-240q0-17-11.5-28.5T480-800q-17 0-28.5 11.5T440-760v240q0 17 11.5 28.5T480-480Z" />
                            </svg>
                        </button>

                        <button type="submit" class="icon-btn search-submit" title="T√¨m ki·∫øm">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#1867f8">
                                <path
                                    d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z" />
                            </svg>
                        </button>
                    </div>
                    <div id="filter-dropdown" class="filter-dropdown-menu">
                        <div class="filter-group">
                            <label>Kho·∫£ng c√°ch:</label>
                            <select name="distance_filter" id="distance_filter" class="custom-select">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">D∆∞·ªõi 1 km</option>
                                <option value="3">D∆∞·ªõi 3 km</option>
                                <option value="5">D∆∞·ªõi 5 km</option>
                                <option value="10">D∆∞·ªõi 10 km</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>M·ª©c gi√°:</label>
                            <select name="price_filter" id="price_filter" class="custom-select">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">D∆∞·ªõi 50k</option>
                                <option value="2">50k - 100k</option>
                                <option value="3">100k - 200k</option>
                                <option value="4">200k - 500k</option>
                                <option value="5">500k - 1tr</option>
                                <option value="6">Tr√™n 1tr</option>
                            </select>
                        </div>
                    </div>

                </form>
                <div id="search_suggestions"></div>
            </div>

            <div class="nav-right">
                <button class="cart-btn-icon" id="open-cart">
                    <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"
                        fill="white">
                        <path
                            d="M280-80q-33 0-56.5-23.5T200-160q0-33 23.5-56.5T280-240q33 0 56.5 23.5T360-160q0 33-23.5 56.5T280-80Zm400 0q-33 0-56.5-23.5T600-160q0-33 23.5-56.5T680-240q33 0 56.5 23.5T760-160q0 33-23.5 56.5T680-80ZM246-720l96 200h280l110-200H246Zm-38-80h590q23 0 35 20.5t1 41.5L692-482q-11 20-29.5 31T622-440H324l-44 80h480v80H280q-45 0-68-39.5t-2-78.5l54-98-144-304H40v-80h130l38 80Zm134 280h280-280Z" />
                    </svg>
                    <span class="cart-count-bubble" id="cart-count" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </header>
    <nav class="breadcrumb"><a href="index.html">Trang ch·ªß</a> / <span id="breadcrumb-product-name">T·ªïng quan s·∫£n ph·∫©m</span></nav>
    <main>
        <div class="product-detail-summary product-summary-col">
            <h2 id="summary-product-name">ƒêang t·∫£i t√™n s·∫£n ph·∫©m...</h2>
            <div class="product-tag" id="summary-product-tag">#tag</div>
            <img id="summary-product-image" class="product-image-main" src="images/placeholder.jpg" alt="·∫¢nh s·∫£n ph·∫©m">
            <p id="summary-product-description">ƒêang t·∫£i m√¥ t·∫£ chi ti·∫øt...</p>
            <div style="margin-top:20px; padding:15px; background:#f0f8ff; border-radius:8px;">
                <div style="font-weight:600;">Kho·∫£ng gi√° chung:</div>
                <div id="summary-product-price" style="font-size:20px; color:#f50000; font-weight:700;">0‚Ç´</div>
            </div>
        </div>

        <div class="store-list-recommend product-summary-col">
            <h3>üõí C√°c c·ª≠a h√†ng ƒëang cung c·∫•p m√≥n n√†y</h3>
            <div id="recommended-stores-list">
                <div style="text-align:center; padding:50px 0;">ƒêang t·∫£i danh s√°ch c·ª≠a h√†ng...</div>
            </div>
        </div>
    </main>

    <div id="cart-popup">
        <h3 style="margin-top:0;">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
        <div class="cart-list" id="cart-list">
            <div style="color:#888">Gi·ªè h√†ng tr·ªëng</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>T·ªïng:</div>
            <div style="font-weight:700" id="cart-total">0‚Ç´</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
            <button class="cart-btn" id="checkout">Thanh to√°n</button>
            <button class="small-btn" id="clear-cart">X√≥a</button>
            <button class="small-btn" id="close-cart" style="margin-left:auto;">ƒê√≥ng</button>
        </div>
    </div>
    <div id="voice_popup" style="display:none;">
        <div class="voice-popup-content">
            <h5>üéôÔ∏è ƒêang nghe...</h5>
            <p>H√£y n√≥i t·ª´ kh√≥a t√¨m ki·∫øm c·ªßa b·∫°n</p>
            <p id="transcript_display" style="min-height: 25px; color: #1867f8; font-weight: bold; margin: 15px 0;"></p>
            <div class="listening-dot">‚Ä¢</div>
            <button type="button" onclick="cancelVoiceSearch()"
                style="padding:10px 20px; background:#666; color:white; border:none; border-radius:8px; cursor:pointer; margin-top:10px;">
                H·ªßy
            </button>
        </div>
    </div>
    <footer>
        <div class="footer">
            <div class="footer-section">
                <div class="footer-logo">
                    <h2 style="color:#00aaff; font-size:28px;">SHOPPY</h2>
                    <p style="color:#ccc;">Web b√°n h√†ng h√†ng ƒë·∫ßu Vi·ªát Nam.</p>
                </div>
                <h3>ƒê·ªëi t√°c thanh to√°n</h3>
                <div class="partners">
                    <img src="images/payment/visa.png" alt="Visa">
                    <img src="images/payment/mastercard.png" alt="Mastercard">
                    <img src="images/payment/momo.png" alt="MoMo">
                    <img src="images/payment/vnpay.jpg" alt="VNPay">
                    <img src="images/payment/vietqr.png" alt="VietQR">
                    <img src="images/payment/mbbank.png" alt="MB Bank">
                    <img src="images/payment/viettinbank.png" alt="Viettinbank">
                </div>
            </div>

            <div class="footer-section">
                <h3>V·ªÅ Shoppy</h3>
                <ul>
                    <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                    <li><a href="#">Li√™n h·ªá</a></li>
                    <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
                    <li><a href="#">Tr·ª£ gi√∫p</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>S·∫£n ph·∫©m</h3>
                <ul>
                    <li><a href="#">ƒê·ªì d√πng h·ªçc t·∫≠p</a></li>
                    <li><a href="#">ƒê·ªì ƒëi·ªán t·ª≠</a></li>
                    <li><a href="#">Th·ªùi trang</a></li>
                    <li><a href="#">ƒê·ªì gia d·ª•ng</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Ch√≠nh s√°ch</h3>
                <ul>
                    <li><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
                    <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
                    <li><a href="#">ƒê·ªïi tr·∫£ & Ho√†n ti·ªÅn</a></li>
                </ul>

                <h3 style="margin-top:20px;">Theo d√µi ch√∫ng t√¥i</h3>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank">
                        <img src="/images/icons/fb.jpg" alt="Facebook">
                    </a>
                    <a href="https://www.instagram.com" target="_blank">
                        <img src="/images/icons/ins.jpg" alt="Instagram">
                    </a>
                    <a href="https://www.tiktok.com" target="_blank">
                        <img src="/images/icons/tiktok.jpg" alt="TikTok">
                    </a>
                    <a href="https://www.youtube.com" target="_blank">
                        <img src="/images/icons/youtube.png" alt="YouTube">
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            @ 2025 Shoppy ‚Äî Khoa CNTT, HCMUS
        </div>
    </footer>
    <div class="custom-modal-overlay" id="custom-confirm-modal" style="
            /* CSS T·ªêI THI·ªÇU ƒë·ªÉ modal ho·∫°t ƒë·ªông ƒë√∫ng */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; 
            align-items: center; z-index: 9000;
        ">
        <div class="custom-modal-content" style="
                background: white; padding: 30px; border-radius: 10px; width: 90%; 
                max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            ">
            <h3 id="modal-title" style="color: #0b38cc; margin-top: 0; margin-bottom: 15px;">X√°c nh·∫≠n</h3>
            <p id="modal-message" style="margin-top: 0; margin-bottom: 25px; font-size: 16px; line-height: 1.5;">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y kh√¥ng?</p>
            <div class="modal-actions" style="display: flex; justify-content: space-around; gap: 15px;">
                <button id="modal-confirm-no"
                    style="width: 45%; padding: 10px; border-radius: 25px; font-size: 14px; text-transform: none; background-color: #ccc; border: 1px solid #ccc; color: #333; cursor: pointer;">H·ªßy</button>
                <button id="modal-confirm-yes"
                    style="width: 45%; padding: 10px; border-radius: 25px; font-size: 14px; text-transform: none; background-color: #0b38cc; border: 1px solid #0b38cc; color: white; cursor: pointer;">ƒê·ªìng
                    √Ω</button>
            </div>
        </div>
    </div>
    <script src="supabase-init.js"></script>
    <script>
        const API_BASE = '';
        const $ = sel => document.querySelector(sel);
        const $$ = sel => document.querySelectorAll(sel);
        // Bi·∫øn l∆∞u tr·ªØ s·∫£n ph·∫©m (product object) hi·ªán t·∫°i
        let currentProductData = null; 
        let cart = JSON.parse(localStorage.getItem('cart_v1') || '{}');


        function formatMoney(n) { 
            if (typeof n !== 'number') return '0‚Ç´';
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '‚Ç´'; 
        }

        // --- H√†m h·ªó tr·ª£ Cart UI (ƒë∆∞·ª£c copy t·ª´ script.js ƒë·ªÉ ƒë·∫£m b·∫£o gi·ªè h√†ng ho·∫°t ƒë·ªông) ---
        // Gi·∫£ l·∫≠p h√†m getCartItemDetails ƒë·ªÉ Cart UI ho·∫°t ƒë·ªông
        function getCartItemDetails(key) {
            // Logic n√†y c·∫ßn ALL_PRODUCTS, nh∆∞ng v√¨ kh√¥ng load to√†n b·ªô tr√™n trang n√†y, 
            // ch√∫ng ta s·∫Ω c·∫ßn l·∫•y info t·ª´ localStorage ho·∫∑c t·∫°m th·ªùi d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh.
            // ƒê·ªÉ ƒë∆°n gi·∫£n, ta ch·ªâ c·∫ßn n√≥ kh√¥ng l·ªói khi updateCartUI ch·∫°y.
            const [productId, storeId] = key.split('_');

            // Do kh√¥ng c√≥ ALL_PRODUCTS tr√™n trang n√†y, ta tr·∫£ v·ªÅ gi·∫£ l·∫≠p
            return {
                name: `SP#${productId} (T·∫£i l·∫°i trang)`,
                store_name: `CH#${storeId}`,
                price: 0,
                img: 'images/placeholder.jpg'
            };
        }

        function saveCart() { localStorage.setItem('cart_v1', JSON.stringify(cart)); updateCartUI(); }
        
        function changeQty(key, delta) {
            cart[key] = (cart[key] || 0) + delta;
            if (cart[key] <= 0) delete cart[key];
            saveCart();
        }

        function removeItem(key) { 
            if (confirm("X√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) { 
                delete cart[key]; 
                saveCart(); 
            } 
        }

        function updateCartUI() {
            const cartList = $('#cart-list');
            const cartCount = Object.values(cart).reduce((s, q) => s + q, 0);
            let total = 0;
            
            const cartCountBubble = $('#cart-count');
            if (cartCountBubble) {
                cartCountBubble.textContent = cartCount;
                cartCountBubble.style.display = cartCount > 0 ? 'block' : 'none';
            }

            if (cartCount === 0) {
                if (cartList) cartList.innerHTML = '<div style="color:#888">Gi·ªè h√†ng tr·ªëng</div>';
                if ($('#cart-total')) $('#cart-total').textContent = formatMoney(0);
                return;
            }

            if (cartList) {
                cartList.innerHTML = '';

                Object.entries(cart).forEach(([key, qty]) => {
                    const itemDetails = getCartItemDetails(key);
                    const price = itemDetails.price || 0;
                    total += price * qty;

                    const item = document.createElement('div');
                    item.className = 'cart-item';

                    item.innerHTML = `
                        <img src="${itemDetails.img}" />

                        <div style="flex:1">
                            <div style="font-size:14px">${itemDetails.name}</div>
                            <div style="font-size:12px;color:#666">${itemDetails.store_name}</div>
                            <div style="font-size:13px;color:#666">
                                ${formatMoney(price)} x ${qty} = ${formatMoney(price * qty)}
                            </div>
                        </div>

                        <div class="qty">
                            <button class="small-btn" onclick="changeQty('${key}', -1)">-</button>
                            <div style="min-width:20px;text-align:center">${qty}</div>
                            <button class="small-btn" onclick="changeQty('${key}', 1)">+</button>

                            <button class="small-btn" style="margin-left:6px" onclick="removeItem('${key}')">x√≥a</button>
                        </div>
                    `;
                    cartList.appendChild(item);
                });
            }
            if ($('#cart-total')) $('#cart-total').textContent = formatMoney(total);
        }

        // --- H·∫øt H√†m h·ªó tr·ª£ Cart UI ---

        // --- H√†m h·ªó tr·ª£ Account/Logout (copy t·ª´ script.js) ---
        async function updateAccountLink() {
            const accountLink = document.getElementById('account-link');
            const logoutLink = document.getElementById('logout-link');

            const { data: { session } } = await supabase.auth.getSession();
            let userName = null;

            if (session && session.user) {
                userName = session.user.user_metadata.name || session.user.email.split('@')[0];
                localStorage.setItem('userName', userName);
            } else {
                localStorage.removeItem('userName');
            }

            if (userName && accountLink) {
                accountLink.innerHTML = `üëã Ch√†o, <b>${userName}</b>`;
                accountLink.href = 'profile.html';
                if (logoutLink) logoutLink.style.display = 'flex';
            } else if (accountLink) {
                accountLink.textContent = 'T√†i Kho·∫£n';
                accountLink.href = 'account.html';
                if (logoutLink) logoutLink.style.display = 'none';
            }
        }
        
        function showCustomConfirm(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                const messageElement = modal.querySelector('#modal-message');
                const yesButton = modal.querySelector('#modal-confirm-yes');
                const noButton = modal.querySelector('#modal-confirm-no');

                if (!modal || !messageElement || !yesButton || !noButton) {
                    resolve(confirm(message));
                    return;
                }

                messageElement.textContent = message;
                modal.style.display = 'flex';

                const handleYes = () => {
                    modal.style.display = 'none';
                    removeListeners();
                    resolve(true);
                };

                const handleNo = () => {
                    modal.style.display = 'none';
                    removeListeners();
                    resolve(false);
                };

                yesButton.addEventListener('click', handleYes, { once: true });
                noButton.addEventListener('click', handleNo, { once: true });

                const removeListeners = () => {
                    yesButton.removeEventListener('click', handleYes);
                    noButton.removeEventListener('click', handleNo);
                };
            });
        }
        
        window.handleLogout = async function () {
            const confirmLogout = await showCustomConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n n√†y kh√¥ng?");
            if (!confirmLogout) return;

            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                localStorage.removeItem('accessToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('cart_v1');

                window.location.reload();

            } catch (err) {
                alert("ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        };

        // --- H√†m h·ªó tr·ª£ Search/Filter (ƒë·ªÉ Header kh√¥ng l·ªói) ---
        window.toggleFilterMenu = function () { 
            const menu = $('#filter-dropdown');
            if (menu) menu.classList.toggle('active'); 
        }
        window.startVoiceSearch = function () { alert("T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i ch·ªâ h·ªó tr·ª£ tr√™n trang ch·ªß."); }
        window.openImageSearch = function () { alert("T√¨m ki·∫øm b·∫±ng h√¨nh ·∫£nh ch·ªâ h·ªó tr·ª£ tr√™n trang ch·ªß."); }
        
        // --- Logic h·ªó tr·ª£ Live Search tr√™n trang n√†y (ch·ªâ ·∫©n khi g√µ) ---
        let suggestionTimeout;
        const searchInput = $('#search_input');
        
        function hideSuggestions() {
            const suggestionsDiv = $('#search_suggestions');
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                hideSuggestions(); 
            }, 300);
        });

        document.addEventListener('click', function(event) {
            const form = $('#search_form');
            const suggestions = $('#search_suggestions');
            if (form && suggestions && !form.contains(event.target) && !suggestions.contains(event.target)) {
              hideSuggestions();
            }
        });
        // --- H·∫æT Logic h·ªó tr·ª£ Live Search ---

        // ======================================================================
        // PH·∫¶N LOGIC TRANG SUMMARY (T·∫¢I D·ªÆ LI·ªÜU)
        // ======================================================================
        
        async function loadProductData(productId) {
            try {
                // S·ª≠ d·ª•ng API /api/products (kh√¥ng filter) ƒë·ªÉ t·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m
                const res = await fetch(`/api/products`);
                const allProducts = await res.json();
                
                // T√¨m s·∫£n ph·∫©m duy nh·∫•t
                const product = allProducts.find(p => p.product_id == productId);

                if (!product) {
                    $('#summary-product-name').textContent = 'S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i';
                    $('#recommended-stores-list').innerHTML = '<div class="no-stores">Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m n√†y.</div>';
                    return null;
                }
                
                currentProductData = product;
                return product;

            } catch (err) {
                console.error("L·ªói khi load Product Data:", err);
                $('#recommended-stores-list').innerHTML = '<div class="no-stores" style="color:red">L·ªói k·∫øt n·ªëi server khi t·∫£i d·ªØ li·ªáu.</div>';
                return null;
            }
        }
        
        function renderProductSummary(product) {
            
            // --- 1. C·∫≠p nh·∫≠t th√¥ng tin t·ªïng quan s·∫£n ph·∫©m ---
            $('#summary-product-name').textContent = product.product_name;
            $('#breadcrumb-product-name').textContent = product.product_name;
            $('#summary-product-tag').textContent = `#${product.tag || 'Chung'}`;
            $('#summary-product-image').src = product.product_image_url || 'images/placeholder.jpg';
            $('#summary-product-description').textContent = product.product_des || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt cho s·∫£n ph·∫©m n√†y.';
            
            const minPrice = product.min_price || product.product_min_cost;
            const maxPrice = product.max_price || product.product_max_cost;

            let priceText = 'Li√™n h·ªá';
            if (minPrice) {
                priceText = formatMoney(minPrice);
                if (maxPrice && maxPrice !== minPrice) {
                    priceText += ` - ${formatMoney(maxPrice)}`;
                }
            }
            $('#summary-product-price').textContent = priceText;


            // --- 2. C·∫≠p nh·∫≠t danh s√°ch c·ª≠a h√†ng ---
            const storeList = $('#recommended-stores-list');
            storeList.innerHTML = '';
            
            if (!product.stores || product.stores.length === 0) {
                storeList.innerHTML = '<div class="no-stores">Hi·ªán kh√¥ng c√≥ c·ª≠a h√†ng n√†o cung c·∫•p s·∫£n ph·∫©m n√†y.</div>';
                return;
            }

            product.stores.forEach(store => {
                const mainImage = store.product_images ? store.product_images.find(img => img.ps_type === 1) : null;
                const storeImageUrl = mainImage ? mainImage.ps_image_url : product.product_image_url;
                
                const rating = store.ps_average_rating ? store.ps_average_rating.toFixed(1) : 'Ch∆∞a c√≥';
                const reviewCount = store.ps_total_reviews ? store.ps_total_reviews : 0;
                
                const storeMinPrice = store.ps_min_price_store || 0;
                const storeMaxPrice = store.ps_max_price_store || 0;

                let storePriceText = formatMoney(storeMinPrice);
                if (storeMaxPrice && storeMaxPrice !== storeMinPrice) {
                     storePriceText += ` - ${formatMoney(storeMaxPrice)}`;
                }

                const storeCard = document.createElement('a');
                storeCard.className = 'store-item-card';
                storeCard.href = `product-detail.html?product_id=${product.product_id}&store_id=${store.store_id}`;
                
                storeCard.innerHTML = `
                    <img src="${storeImageUrl}" alt="${store.store_name}">
                    <div class="store-info">
                        <div class="store-name">${store.store_name}</div>
                        <div style="font-size:14px; color:#555;">ƒê·ªãa ch·ªâ: ${store.store_address || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                        <div class="store-price">Gi√°: ${storePriceText}</div>
                        <div class="store-review">‚≠ê ${rating} (${reviewCount} ƒë√°nh gi√°)</div>
                    </div>
                    <div class="store-actions">
                        <button>Xem Chi Ti·∫øt</button>
                    </div>
                `;

                storeList.appendChild(storeCard);
            });
        }


        async function init() {
            const params = new URLSearchParams(window.location.search);
            const product_id = params.get('product_id');

            if (!product_id) { 
                document.body.innerHTML = '<h2 style="padding:50px">Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m. Vui l√≤ng quay l·∫°i trang ch·ªß.</h2>'; 
                return; 
            }
            
            const product = await loadProductData(product_id);
            
            if (product) {
                renderProductSummary(product);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             updateAccountLink(); 
             updateCartUI(); // C·∫≠p nh·∫≠t gi·ªè h√†ng l·∫ßn ƒë·∫ßu
             init();

             // Ch·ª©c nƒÉng chuy·ªÉn h∆∞·ªõng T√¨m ki·∫øm tr√™n Header
             $('#search_form').onsubmit = (e) => {
                e.preventDefault();
                // Chuy·ªÉn h∆∞·ªõng v·ªÅ index.html k√®m theo query
                window.location.href = `index.html?search=${$('#search_input').value}`; 
            };
            
            // Toggle popup gi·ªè h√†ng
            if ($('#open-cart')) {
                $('#open-cart').addEventListener('click', () => {
                    const popup = $('#cart-popup');
                    popup.style.display = (popup.style.display === 'block') ? 'none' : 'block';
                });
            }

            if ($('#close-cart')) {
                $('#close-cart').addEventListener('click', () => {
                    $('#cart-popup').style.display = 'none';
                });
            }

            if ($('#clear-cart')) {
                $('#clear-cart').addEventListener('click', () => {
                    if (confirm('X√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                        cart = {};
                        saveCart();
                    }
                });
            }
            
            // N√∫t checkout ‚Üí chuy·ªÉn sang cart.html
            if ($('#checkout')) {
                $('#checkout').addEventListener('click', (e) => {
                    e.preventDefault();
                    const count = Object.values(cart).reduce((s, q) => s + q, 0);
                    if (count === 0) {
                        alert('Gi·ªè h√†ng ƒëang r·ªóng.');
                        return;
                    }
                    window.location.href = 'cart.html';
                });
            }
        });
    </script>
</body>

</html>